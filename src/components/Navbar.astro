---
// src/components/Navbar.astro
// Check authentication server-side
let isAuthenticated = false;
try {
  const { getVendorIdFromToken } = await import('../utils/jwt');
  const cookieHeader = Astro.request.headers.get('cookie') || '';
  const cookies: Record<string, string> = {};
  cookieHeader.split(';').forEach(cookie => {
    const [name, ...rest] = cookie.trim().split('=');
    if (name) {
      cookies[name] = rest.join('=');
    }
  });
  
  if (cookies.token) {
    getVendorIdFromToken(cookies.token);
    isAuthenticated = true;
  }
} catch {
  // Token is invalid or missing
  isAuthenticated = false;
}
---
<nav class="bg-brand-bg border-b border-gray-200 p-4 shadow-md">
    <div class="max-w-7xl mx-auto flex items-center justify-between">
      <a href="/" class="text-2xl font-extrabold font-heading text-brand-magenta">Vibe</a>
      <div class="flex items-center space-x-6">
        <a href="/" class="font-bold hover:text-brand-teal transition-colors">Home</a>
        <a href="/shop" class="font-bold hover:text-brand-teal transition-colors">Shop</a>
        <a href="/sell" class="font-bold hover:text-brand-teal transition-colors">Sell with Us</a>
        <a href="/about" class="font-bold hover:text-brand-teal transition-colors">About Us</a>
        <a href="/contact" class="font-bold hover:text-brand-teal transition-colors">Contact</a>
        
        {isAuthenticated ? (
          <>
            <a href="/vendor-portal" class="font-bold hover:text-brand-teal transition-colors">Vendor Portal</a>
            <button id="logoutBtn" class="font-bold hover:text-brand-teal transition-colors">Logout</button>
          </>
        ) : (
          <>
            <a href="/login" class="font-bold hover:text-brand-teal transition-colors">Login</a>
            <a href="/register" class="font-bold hover:text-brand-teal transition-colors">Register</a>
          </>
        )}
      </div>
    </div>
  </nav>
  
  {isAuthenticated && (
    <script is:inline type="module">
      // Logout handler
      document.getElementById('logoutBtn')?.addEventListener('click', () => {
        // Clear the HttpOnly cookie by making a server request
        fetch('/api/auth/logout', { 
          method: 'POST',
          credentials: 'include' 
        }).then(() => {
          window.location.href = '/';
        }).catch(() => {
          // Fallback: redirect anyway
          window.location.href = '/';
        });
      });
    </script>
  )}
  